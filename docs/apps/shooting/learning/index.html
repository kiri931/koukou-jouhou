<!doctype html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Learning: シューティングを小さく作る</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header class="header">
    <div class="header-row">
      <div>
        <h1>シューティングゲームを作ろう</h1>
        <p class="sub">
          左にサンプル、右に自分のコードを置いて学習できます。
        </p>
      </div>
      <div class="header-actions">
        <label class="themeLabel" for="themeSelect">表示</label>
        <select id="themeSelect" class="select" aria-label="テーマ">
          <option value="auto">自動</option>
          <option value="light">ライト</option>
          <option value="dark">ダーク</option>
        </select>
      </div>
    </div>
    <div class="header-actions">
      <label class="btn" for="importFileTop">インポート</label>
      <input id="importFileTop" class="fileInput" type="file" accept="application/json,.json" />
      <a class="btnLink" href="viewer.html">提出ビューワー</a>
      <a class="btnLink" href="selftest.html">自動ジャッジ</a>
    </div>
  </header>

  <main class="container">
    <section class="panel">
      <h2>ステップ一覧</h2>
      <ol class="steps" id="stepsList">
        <li><a href="playground.html?step=step1" data-step="step1">Step1: Canvasを表示する</a> <span class="step-status" data-step-status="step1"></span></li>
        <li><a href="playground.html?step=step2" data-step="step2">Step2: 自機（四角）を表示する</a> <span class="step-status" data-step-status="step2"></span></li>
        <li><a href="playground.html?step=step3" data-step="step3">Step3: 自機を左右に動かす</a> <span class="step-status" data-step-status="step3"></span></li>
        <li><a href="playground.html?step=step4" data-step="step4">Step4: 画像で自機を表示する</a> <span class="step-status" data-step-status="step4"></span></li>
        <li><a href="playground.html?step=step5" data-step="step5">Step5: ゲームループ（更新→描画）</a> <span class="step-status" data-step-status="step5"></span></li>
        <li><a href="playground.html?step=step6" data-step="step6">Step6: 弾を1発撃つ（配列なし）</a> <span class="step-status" data-step-status="step6"></span></li>
        <li><a href="playground.html?step=step7" data-step="step7">Step7: 弾を複数（配列）</a> <span class="step-status" data-step-status="step7"></span></li>
        <li><a href="playground.html?step=step8" data-step="step8">Step8: 敵（直進）</a> <span class="step-status" data-step-status="step8"></span></li>
        <li><a href="playground.html?step=step9" data-step="step9">Step9: ファイルを分けよう（モジュール化）</a> <span class="step-status" data-step-status="step9"></span></li>
        <li><a href="playground.html?step=step10" data-step="step10">Step10: 当たり判定（弾×敵）</a> <span class="step-status" data-step-status="step10"></span></li>
        <li><a href="playground.html?step=step11" data-step="step11">Step11: スコア表示</a> <span class="step-status" data-step-status="step11"></span></li>
        <li><a href="playground.html?step=step12" data-step="step12">Step12: ライフ＋ゲームオーバー</a> <span class="step-status" data-step-status="step12"></span></li>
        <li><a href="playground.html?step=step13" data-step="step13">Step13: 仕上げ（完成版）</a> <span class="step-status" data-step-status="step13"></span></li>
      </ol>
    </section>

    <section class="panel">
      <h2>使い方</h2>
      <ul class="howto">
        <li>各Stepを開くと、左に「サンプル実行」、右に「自分の実行」が出ます。</li>
        <li>右側のHTML/CSS/JSを編集して <b>実行</b> を押すと反映されます。</li>
        <li>画像は <code>learning/image/</code> を参照します（例: <code>../image/player.png</code>）。</li>
        <li>事前に確認したい人向け：<a href="../print/guide.html">事前学習ガイド（print）</a></li>
      </ul>
    </section>

    <section class="panel">
      <h2>データ管理とジャッジ</h2>
      <ul class="howto">
        <li><b>インポート</b>：上部の「インポート」ボタンから、エクスポートしたJSONファイルを読み込めます。</li>
        <li><b>自動ジャッジ</b>：<a href="selftest.html">自動ジャッジ</a> で、各Stepのコードが正しく動作するか自動テストできます。</li>
        <li><b>提出ビューワー</b>：<a href="viewer.html">提出ビューワー</a> で、複数の提出JSONを一括で確認できます。</li>
      </ul>
    </section>
  </main>

  <script src="theme.js"></script>
  <script>
    const STORAGE_PREFIX = "shooting:learning:playground:v1";

    // サンプルコードを読み込む
    const sampleCache = {};
    async function loadStepSample(step) {
      if (sampleCache[step]) return sampleCache[step];
      
      try {
        const [htmlRes, cssRes, jsRes] = await Promise.all([
          fetch(`./${step}/index.html`).then(r => r.ok ? r.text() : ""),
          fetch(`./${step}/style.css`).then(r => r.ok ? r.text() : ""),
          fetch(`./${step}/main.js`).then(r => r.ok ? r.text() : "")
        ]);
        
        sampleCache[step] = {
          html: htmlRes || "",
          css: cssRes || "",
          js: jsRes || ""
        };
        return sampleCache[step];
      } catch {
        return { html: "", css: "", js: "" };
      }
    }

    // コードが編集されているか判定（空白・改行を正規化して比較）
    function normalizeCode(code) {
      return String(code || "").trim().replace(/\s+/g, " ");
    }

    function isEdited(saved, sample) {
      if (!saved) return false;
      
      const savedNorm = {
        html: normalizeCode(saved.html),
        css: normalizeCode(saved.css),
        js: normalizeCode(saved.js)
      };
      
      const sampleNorm = {
        html: normalizeCode(sample.html),
        css: normalizeCode(sample.css),
        js: normalizeCode(sample.js)
      };
      
      // いずれかが編集されていればtrue
      return savedNorm.html !== sampleNorm.html ||
             savedNorm.css !== sampleNorm.css ||
             savedNorm.js !== sampleNorm.js;
    }

    // ステップのチェック状態を更新
    async function updateStepStatus() {
      const steps = ["step1", "step2", "step3", "step4", "step5", "step6", "step7", "step8", "step9", "step10", "step11", "step12", "step13"];
      
      for (const step of steps) {
        const statusEl = document.querySelector(`[data-step-status="${step}"]`);
        if (!statusEl) continue;

        const savedData = localStorage.getItem(`${STORAGE_PREFIX}:${step}`);
        
        if (savedData) {
          try {
            const data = JSON.parse(savedData);
            
            // サンプルコードを読み込んで比較
            const sample = await loadStepSample(step);
            
            if (isEdited(data, sample)) {
              statusEl.textContent = "✓";
              statusEl.style.color = "#22c55e";
              statusEl.style.fontWeight = "bold";
              statusEl.title = "編集済み";
            } else {
              statusEl.textContent = "○";
              statusEl.style.color = "#94a3b8";
              statusEl.style.fontWeight = "normal";
              statusEl.title = "未編集（サンプルのまま）";
            }
          } catch {
            statusEl.textContent = "";
          }
        } else {
          statusEl.textContent = "";
        }
      }
    }

    // インポート機能
    document.getElementById("importFileTop")?.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        if (!data || typeof data !== "object") {
          alert("無効なJSONファイルです。");
          return;
        }

        // Export形式（items配列）とStep配列両方に対応
        let imported = 0;
        const itemsData = data.items || data;
        
        for (const [key, value] of Object.entries(itemsData)) {
          if (key.startsWith("step")) {
            localStorage.setItem(`${STORAGE_PREFIX}:${key}`, JSON.stringify(value));
            imported++;
          }
        }

        if (imported > 0) {
          alert(`${imported}個のStepデータをインポートしました。`);
          e.target.value = ""; // リセット
          updateStepStatus(); // チェック状態を更新
        } else {
          alert("インポート可能なStepデータが見つかりませんでした。");
        }
      } catch (err) {
        console.error(err);
        alert("インポートに失敗しました: " + err.message);
      }
    });

    // ページ読み込み時にチェック状態を更新
    updateStepStatus();

    // 定期的にチェック（他のタブで更新された場合に対応）
    setInterval(updateStepStatus, 2000);
  </script>
</body>

</html>
