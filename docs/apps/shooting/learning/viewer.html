<!doctype html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æå‡ºãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼</title>
  <link rel="stylesheet" href="style.css?v=20260113" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css" />
  <link id="cmThemeLink" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/eclipse.min.css" />
  <style>
    .stats-panel {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, var(--accent, #0066cc) 0%, var(--accent-dark, #0052a3) 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    .stats-panel .h2 {
      color: white;
      margin-bottom: 16px;
    }
    .stats-container {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 24px;
      align-items: center;
    }
    .stats-main {
      text-align: center;
      padding: 16px 32px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    .stats-number {
      font-size: 64px;
      font-weight: bold;
      line-height: 1;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      font-variant-numeric: tabular-nums;
    }
    .stats-label {
      font-size: 18px;
      margin-top: 8px;
      opacity: 0.9;
    }
    .stats-details {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .stats-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }
    .stats-item-label {
      font-weight: 500;
      opacity: 0.9;
    }
    .stats-item-value {
      font-size: 24px;
      font-weight: bold;
      font-variant-numeric: tabular-nums;
    }
    .stats-files {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      backdrop-filter: blur(10px);
      min-width: 280px;
    }
    .stats-file-info {
      font-size: 14px;
      opacity: 0.95;
      word-break: break-all;
    }
    .stats-files .btn {
      margin-top: 8px;
      background: white;
      color: var(--accent, #0066cc);
      font-weight: bold;
    }
    .stats-files .btn:hover {
      background: rgba(255, 255, 255, 0.9);
    }
    @media (max-width: 1200px) {
      .stats-container {
        grid-template-columns: 1fr;
      }
      .stats-main {
        order: -1;
      }
    }
  </style>
</head>

<body>
  <header class="header header-row">
    <div>
      <a class="back" href="index.html">â† ä¸€è¦§ã¸</a>
      <h1>æå‡ºãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼</h1>
      <p class="sub">è¤‡æ•°ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/æå‡ºJSONã‚’èª­ã¿è¾¼ã‚“ã§ã€ä¸€æ‹¬ç¢ºèªã§ãã¾ã™ã€‚</p>
    </div>

    <div class="header-actions">
      <div class="controlGroup">
        <label class="themeLabel" for="themeSelect">è¡¨ç¤º</label>
        <select id="themeSelect" class="select" aria-label="ãƒ†ãƒ¼ãƒ">
          <option value="auto">è‡ªå‹•</option>
          <option value="light">ãƒ©ã‚¤ãƒˆ</option>
          <option value="dark">ãƒ€ãƒ¼ã‚¯</option>
        </select>
      </div>

      <div class="controlGroup">
        <label class="themeLabel" for="cmThemeSelect">ã‚¨ãƒ‡ã‚£ã‚¿</label>
        <select id="cmThemeSelect" class="select" aria-label="ã‚¨ãƒ‡ã‚£ã‚¿ãƒ†ãƒ¼ãƒ">
          <option value="auto">è‡ªå‹•</option>
          <option value="eclipse">Eclipseï¼ˆæ˜ï¼‰</option>
          <option value="idea">IDEAï¼ˆæ˜ï¼‰</option>
          <option value="neo">Neoï¼ˆæ˜ï¼‰</option>
          <option value="material-darker">Material Darkerï¼ˆæš—ï¼‰</option>
          <option value="darcula">Darculaï¼ˆæš—ï¼‰</option>
          <option value="dracula">Draculaï¼ˆæš—ï¼‰</option>
          <option value="monokai">Monokaiï¼ˆæš—ï¼‰</option>
        </select>
      </div>

      <label class="btn" for="viewerFiles">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ </label>
      <input id="viewerFiles" class="fileInput" type="file" accept="application/json,.json" multiple />
      <button id="clearBtn" class="btn" type="button">ã‚¯ãƒªã‚¢</button>
    </div>
  </header>

  <main class="workspace viewer">
    <!-- æ–‡å­—æ•°çµ±è¨ˆãƒ‘ãƒãƒ« -->
    <section class="col stats-panel" id="statsPanel" hidden>
      <h2 class="h2">ğŸ“Š æœ¬æ—¥ã®å…¥åŠ›æ–‡å­—æ•°</h2>
      <div class="stats-container">
        <div class="stats-main">
          <div class="stats-number" id="totalChars">0</div>
          <div class="stats-label">æ–‡å­—</div>
        </div>
        <div class="stats-details">
          <div class="stats-item">
            <span class="stats-item-label">HTML:</span>
            <span class="stats-item-value" id="htmlChars">0</span>
          </div>
          <div class="stats-item">
            <span class="stats-item-label">CSS:</span>
            <span class="stats-item-value" id="cssChars">0</span>
          </div>
          <div class="stats-item">
            <span class="stats-item-label">JavaScript:</span>
            <span class="stats-item-value" id="jsChars">0</span>
          </div>
        </div>
        <div class="stats-files">
          <div class="stats-file-info">
            <strong>ä½œæ¥­å‰:</strong> <span id="beforeFile">æœªé¸æŠ</span>
          </div>
          <div class="stats-file-info">
            <strong>ä½œæ¥­å¾Œ:</strong> <span id="afterFile">æœªé¸æŠ</span>
          </div>
          <button id="statsCalcBtn" class="btn" type="button">æ–‡å­—æ•°ã‚’è¨ˆç®—</button>
        </div>
      </div>
    </section>

    <section class="col">
      <h2 class="h2">èª­ã¿è¾¼ã¿æ¸ˆã¿</h2>
      <div id="fileList" class="viewerList" aria-label="ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§"></div>
    </section>

    <section class="col">
      <h2 class="h2">ã‚¹ãƒ†ãƒƒãƒ—</h2>
      <div id="stepList" class="viewerList" aria-label="ã‚¹ãƒ†ãƒƒãƒ—ä¸€è¦§"></div>
    </section>

    <section class="col">
      <h2 class="h2" id="detailTitle">å†…å®¹</h2>
      <div class="tabs" role="tablist" aria-label="è¡¨ç¤ºã™ã‚‹ç¨®é¡">
        <button class="tab" type="button" role="tab" aria-selected="true" data-view-tab="html">HTML</button>
        <button class="tab" type="button" role="tab" aria-selected="false" data-view-tab="css">CSS</button>
        <button class="tab" type="button" role="tab" aria-selected="false" data-view-tab="js">JavaScript</button>
      </div>
      <div class="viewerCode">
        <textarea id="viewHtml" spellcheck="false"></textarea>
        <textarea id="viewCss" spellcheck="false" hidden></textarea>
        <textarea id="viewJs" spellcheck="false" hidden></textarea>
      </div>

      <details id="compareDetails" class="guideDiffDetails viewerCompareDetails" hidden>
        <summary>æ¯”è¼ƒï¼ˆæ–°æ—§å·®åˆ†ï¼‰</summary>
        <div class="diffControls">
          <div class="controlGroup">
            <label class="themeLabel" for="compareOld">æ—§</label>
            <select id="compareOld" class="select" aria-label="æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³"></select>
          </div>
          <div class="controlGroup">
            <label class="themeLabel" for="compareNew">æ–°</label>
            <select id="compareNew" class="select" aria-label="æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³"></select>
          </div>
          <button id="compareSwapBtn" class="btn" type="button">å…¥ã‚Œæ›¿ãˆ</button>
          <button id="compareRefreshBtn" class="btn" type="button">å·®åˆ†ã‚’æ›´æ–°</button>
        </div>
        <div id="compareDiff" class="diffView" aria-label="å·®åˆ†è¡¨ç¤º"></div>
        <p id="compareHint" class="diffHint"></p>
      </details>

      <div id="viewerMeta" class="status"></div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/css/css.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>

  <script src="theme.js?v=20260113"></script>
  <script src="viewer.js?v=20260116"></script>
  <script>
    // æ–‡å­—æ•°çµ±è¨ˆæ©Ÿèƒ½
    (function() {
      let loadedFiles = [];
      let beforeFileIndex = null;
      let afterFileIndex = null;
      
      const statsPanel = document.getElementById('statsPanel');
      const totalCharsEl = document.getElementById('totalChars');
      const htmlCharsEl = document.getElementById('htmlChars');
      const cssCharsEl = document.getElementById('cssChars');
      const jsCharsEl = document.getElementById('jsChars');
      const beforeFileEl = document.getElementById('beforeFile');
      const afterFileEl = document.getElementById('afterFile');
      const statsCalcBtn = document.getElementById('statsCalcBtn');
      
      // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã®å¤‰æ›´ã‚’ç›£è¦–
      const fileListObserver = new MutationObserver(function() {
        checkFileCount();
      });
      
      const fileListEl = document.getElementById('fileList');
      if (fileListEl) {
        fileListObserver.observe(fileListEl, { childList: true, subtree: true });
      }
      
      function checkFileCount() {
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        const fileItems = fileListEl?.querySelectorAll('[data-file-index]');
        if (fileItems && fileItems.length >= 2) {
          statsPanel.hidden = false;
          captureLoadedFiles();
        } else {
          statsPanel.hidden = true;
        }
      }
      
      function captureLoadedFiles() {
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        if (window.viewerData && window.viewerData.files) {
          loadedFiles = window.viewerData.files;
        }
      }
      
      // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ä½œæ¥­å‰/å¾Œã¨ã—ã¦è¨­å®š
      document.addEventListener('click', function(e) {
        const fileItem = e.target.closest('[data-file-index]');
        if (!fileItem) return;
        
        const index = parseInt(fileItem.dataset.fileIndex, 10);
        if (isNaN(index)) return;
        
        // Shiftã‚­ãƒ¼: ä½œæ¥­å‰ã€Ctrlã‚­ãƒ¼: ä½œæ¥­å¾Œ
        if (e.shiftKey) {
          beforeFileIndex = index;
          const fileName = fileItem.textContent.trim();
          beforeFileEl.textContent = fileName || `ãƒ•ã‚¡ã‚¤ãƒ«${index + 1}`;
          updateCalculation();
        } else if (e.ctrlKey || e.metaKey) {
          afterFileIndex = index;
          const fileName = fileItem.textContent.trim();
          afterFileEl.textContent = fileName || `ãƒ•ã‚¡ã‚¤ãƒ«${index + 1}`;
          updateCalculation();
        }
      });
      
      statsCalcBtn?.addEventListener('click', function() {
        // æœ€åˆã®2ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•é¸æŠ
        if (loadedFiles.length >= 2) {
          beforeFileIndex = 0;
          afterFileIndex = 1;
          
          const fileItems = fileListEl?.querySelectorAll('[data-file-index]');
          if (fileItems) {
            beforeFileEl.textContent = fileItems[0]?.textContent.trim() || 'ãƒ•ã‚¡ã‚¤ãƒ«1';
            afterFileEl.textContent = fileItems[1]?.textContent.trim() || 'ãƒ•ã‚¡ã‚¤ãƒ«2';
          }
          
          updateCalculation();
        }
      });
      
      function updateCalculation() {
        captureLoadedFiles();
        
        if (beforeFileIndex === null || afterFileIndex === null) return;
        if (!loadedFiles[beforeFileIndex] || !loadedFiles[afterFileIndex]) return;
        
        const beforeData = loadedFiles[beforeFileIndex].data;
        const afterData = loadedFiles[afterFileIndex].data;
        
        if (!beforeData?.items || !afterData?.items) return;
        
        let totalHtml = 0, totalCss = 0, totalJs = 0;
        
        // å…¨ã‚¹ãƒ†ãƒƒãƒ—ã®å·®åˆ†ã‚’è¨ˆç®—
        const allSteps = new Set([...Object.keys(beforeData.items), ...Object.keys(afterData.items)]);
        
        allSteps.forEach(function(step) {
          const before = beforeData.items[step] || { html: '', css: '', js: '' };
          const after = afterData.items[step] || { html: '', css: '', js: '' };
          
          const beforeHtmlLen = String(before.html || '').length;
          const afterHtmlLen = String(after.html || '').length;
          const beforeCssLen = String(before.css || '').length;
          const afterCssLen = String(after.css || '').length;
          const beforeJsLen = String(before.js || '').length;
          const afterJsLen = String(after.js || '').length;
          
          totalHtml += Math.max(0, afterHtmlLen - beforeHtmlLen);
          totalCss += Math.max(0, afterCssLen - beforeCssLen);
          totalJs += Math.max(0, afterJsLen - beforeJsLen);
        });
        
        const total = totalHtml + totalCss + totalJs;
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§æ•°å€¤ã‚’æ›´æ–°
        animateNumber(totalCharsEl, total);
        animateNumber(htmlCharsEl, totalHtml);
        animateNumber(cssCharsEl, totalCss);
        animateNumber(jsCharsEl, totalJs);
      }
      
      function animateNumber(element, targetValue) {
        const currentValue = parseInt(element.textContent, 10) || 0;
        const duration = 500; // 500ms
        const startTime = Date.now();
        
        function update() {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);
          
          // ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°é–¢æ•°ï¼ˆeaseOutQuadï¼‰
          const eased = 1 - (1 - progress) * (1 - progress);
          const value = Math.round(currentValue + (targetValue - currentValue) * eased);
          
          element.textContent = value.toLocaleString();
          
          if (progress < 1) {
            requestAnimationFrame(update);
          }
        }
        
        update();
      }
      
      // viewer.jsã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
      window.viewerData = window.viewerData || {};
    })();
  </script>
</body>

</html>
