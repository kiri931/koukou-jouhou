<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ ï¼šç¦å³¶ï¼ˆåŸç™ºï¼‰ã¨é˜²ç½ã‚°ãƒƒã‚º</title>
  <style>
    :root {
      --dg-color-bg: #ffffff;
      --dg-color-surface: #f6f8fb;
      --dg-color-surface-2: #eef2f7;
      --dg-color-border: #d7dee8;
      --dg-color-text: #0b1220;
      --dg-color-muted: #4b5565;
      --dg-color-primary: #0b5ed7;
      --dg-color-primary-hover: #0a53be;
      --dg-color-primary-active: #084298;
      --dg-color-on-primary: #ffffff;
      --dg-color-danger: #b42318;
      --dg-color-success: #067647;
      --dg-shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.06);
      --dg-shadow-md: 0 8px 24px rgba(15, 23, 42, 0.10);
      --dg-radius-sm: 8px;
      --dg-radius-md: 12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; 
      background:var(--dg-color-bg);
      color:var(--dg-color-text); 
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", Arial;
      line-height: 1.7;
    }
    header{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(180deg, #ffffff 0%, #ffffff 55%, #fbfdff 100%);
      border-bottom:1px solid var(--dg-color-border);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:20px 16px}
    h1{margin:0;font-size:22px;letter-spacing:.01em;font-weight:700}
    .sub{margin-top:8px;color:var(--dg-color-muted);font-size:14px;line-height:1.6}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border:1px solid var(--dg-color-border); border-radius:999px;
      background:var(--dg-color-surface); color:var(--dg-color-muted); font-size:12px;
    }
    main .wrap{padding-top:24px; padding-bottom:60px}
    .grid{display:grid; gap:16px}
    @media(min-width:900px){ .grid{grid-template-columns: 1.1fr .9fr} }
    .card{
      background:var(--dg-color-bg);
      border:1px solid var(--dg-color-border);
      border-radius:var(--dg-radius-md);
      box-shadow:var(--dg-shadow-sm);
      padding:20px;
    }
    .card h2{margin:0 0 12px;font-size:18px;font-weight:700}
    .hint{color:var(--dg-color-muted); font-size:14px; line-height:1.7}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:16px}
    button{
      cursor:pointer; 
      border:1px solid transparent;
      background:var(--dg-color-primary);
      color:var(--dg-color-on-primary);
      border-radius:10px;
      padding:10px 14px;
      font-weight:700;
      min-height:40px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition: background 0.15s ease;
    }
    button:hover{background:var(--dg-color-primary-hover)}
    button:active{background:var(--dg-color-primary-active)}
    button.primary{
      background:var(--dg-color-primary);
      color:var(--dg-color-on-primary);
    }
    button.ok{
      background:var(--dg-color-success);
      color:#ffffff;
    }
    button.ok:hover{background:#056538}
    button.danger{
      background:var(--dg-color-danger);
      color:#ffffff;
    }
    button.danger:hover{background:#9e1f15}
    button:disabled{opacity:.5; cursor:not-allowed}
    button:not(.primary):not(.ok):not(.danger){
      background:var(--dg-color-surface);
      color:var(--dg-color-text);
      border-color:var(--dg-color-border);
    }
    button:not(.primary):not(.ok):not(.danger):hover{
      background:var(--dg-color-surface-2);
    }
    button.subtle {
      background:var(--dg-color-surface);
      color:var(--dg-color-text);
      border-color:var(--dg-color-border);
    }
    button.subtle:hover {
      background:var(--dg-color-surface-2);
    }
    textarea, input, select{
      width:100%;
      background:var(--dg-color-bg);
      color:var(--dg-color-text);
      border:1px solid var(--dg-color-border);
      border-radius:var(--dg-radius-sm);
      padding:10px 12px;
      outline:none;
      font-family:inherit;
      font-size:14px;
    }
    textarea:focus, input:focus, select:focus{
      border-color:var(--dg-color-primary);
      box-shadow: 0 0 0 3px rgba(11, 94, 215, 0.15);
    }
    textarea{min-height:88px; resize:vertical}
    table{width:100%; border-collapse:collapse; border-radius:var(--dg-radius-sm); overflow:hidden}
    th,td{border-bottom:1px solid var(--dg-color-border); padding:12px; vertical-align:top}
    th{text-align:left; background:var(--dg-color-surface); color:var(--dg-color-text); font-size:14px; font-weight:700}
    .tiny{font-size:12px; color:var(--dg-color-muted)}
    .tag{
      display:inline-block; 
      padding:4px 10px; 
      border-radius:999px; 
      border:1px solid var(--dg-color-border); 
      background:var(--dg-color-surface);
      font-size:12px; 
      color:var(--dg-color-muted);
      font-weight:600;
    }
    .stepbar{display:flex; gap:10px; align-items:center; margin-top:12px}
    .dot{
      width:10px;
      height:10px;
      border-radius:50%; 
      background:var(--dg-color-surface-2); 
      border:1px solid var(--dg-color-border)
    }
    .dot.on{background:var(--dg-color-primary)}
    .hidden{display:none !important}
    .split{display:flex; gap:12px; flex-wrap:wrap}
    .split > *{flex:1 1 260px}
    .cards{display:grid; gap:16px; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); margin-top:16px}
    .item{
      border:1px solid var(--dg-color-border);
      border-radius:var(--dg-radius-md);
      overflow:hidden;
      background:var(--dg-color-bg);
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      cursor:pointer;
    }
    .item:hover{
      transform: translateY(-2px);
      box-shadow:var(--dg-shadow-md);
    }
    .item.selected{
      border-color: var(--dg-color-success);
      box-shadow: 0 0 0 3px rgba(6, 118, 71, 0.15);
    }
    .thumb{
      height:140px; 
      background:var(--dg-color-surface); 
      display:flex; 
      align-items:center; 
      justify-content:center;
      border-bottom:1px solid var(--dg-color-border);
    }
    .thumb img{width:100%; height:100%; object-fit:cover}
    .item .body{padding:12px}
    .item .title{font-weight:700;font-size:15px}
    .item .desc{margin-top:6px; color:var(--dg-color-muted); font-size:13px; line-height:1.5}
    .count{font-weight:700;color:var(--dg-color-primary)}
    .reason{margin-top:12px}
    .two{display:grid; gap:12px}
    @media(min-width:900px){ .two{grid-template-columns: 1fr 1fr} }
    .modal-back{
      position:fixed; inset:0; background:rgba(11, 18, 32, 0.4);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:99;
      backdrop-filter:blur(4px);
    }
    .modal{
      width:min(720px, 100%);
      background:var(--dg-color-bg);
      border:1px solid var(--dg-color-border);
      border-radius:var(--dg-radius-md); 
      padding:24px; 
      box-shadow:var(--dg-shadow-md);
    }
    .modal h3{margin:0 0 16px;font-size:18px;font-weight:700}
    .modal-back.show{display:flex}
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:12px; 
      border:1px dashed var(--dg-color-border); 
      border-radius:var(--dg-radius-sm);
      background:var(--dg-color-surface);
      margin-top:12px;
    }

    @media print {
      header, .no-print {display:none !important}
      body{background:#fff;color:#000}
      .card{box-shadow:none; border:1px solid #ddd; background:#fff}
      .item{border:1px solid #ddd; background:#fff}
      .thumb{height:120px}
      textarea, input{border:1px solid #bbb; background:#fff; color:#000}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ ï¼šç¦å³¶ï¼ˆåŸç™ºï¼‰ã¨é˜²ç½</h1>
        <div class="sub">â‘ è‡ªåˆ†ã®é˜²ç½ã‚°ãƒƒã‚ºæ¡ˆã‚’å‡ºã™ â†’ â‘¡é…å¸ƒã‚«ãƒ¼ãƒ‰ã‹ã‚‰ <b>5æš</b> é¸ã³ã€ç†ç”±ã‚’è¨€èªåŒ– â†’ â‘¢ï¼ˆä»»æ„ï¼‰ã‚«ãƒ¼ãƒ‰ã‚’è‡ªä½œ</div>
      </div>
      <div class="row no-print">
        <span class="pill">ä¿å­˜ï¼šã“ã®PCã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰</span>
        <a href="viewer.html" style="text-decoration:none;color:inherit">
          <button class="subtle">ğŸ“Š æå‡ºãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>
        </a>
        <button id="btnPrint">å°åˆ·</button>
        <button id="btnReset" class="danger">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
    <div class="stepbar" aria-label="ã‚¹ãƒ†ãƒƒãƒ—">
      <span class="dot on" id="dot1"></span><span class="tiny">STEP1</span>
      <span class="dot" id="dot2"></span><span class="tiny">STEP2</span>
      <span class="dot" id="dot3"></span><span class="tiny">STEP3</span>
      <span class="dot" id="dot4"></span><span class="tiny">æŒ¯ã‚Šè¿”ã‚Š</span>
      <span class="dot" id="dot5"></span><span class="tiny">æå‡º</span>
    </div>
  </div>
</header>

<main>
  <div class="wrap grid">
    <section class="card">
      <h2>å°å…¥ï¼ˆå…ˆç”Ÿç”¨ãƒ¡ãƒ¢ï¼‰</h2>
      <div class="hint">
        <ul>
          <li>ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒï¼š<b>ç¦å³¶ã®åŸç™ºäº‹æ•…</b>ã‚’å…¥å£ã«ã€ã€Œæƒ…å ±ã€ã€Œå‚™ãˆã€ã€Œç”Ÿæ´»ã®ç¶™ç¶šã€ã‚’è€ƒãˆã‚‹ã€‚</li>
          <li>å¼·èª¿ã—ãŸã„è¦³ç‚¹ï¼š<b>é¿é›£ãƒ»åœé›»ãƒ»æ–­æ°´ãƒ»é€šä¿¡æ–­</b>ãªã©ã€åŸç™ºã«é™ã‚‰ãšç½å®³æ™‚ã«èµ·ãã‚‹â€œç”Ÿæ´»ã®å›°ã‚Šã”ã¨â€ã€‚</li>
          <li>æ³¨æ„ï¼šä¸å®‰ã‚’ç…½ã‚‰ãªã„ã€‚<b>äº‹å®Ÿï¼æ¨æ¸¬</b>ã‚’åˆ†ã‘ã€SNSæƒ…å ±ã®æ‰±ã„ï¼ˆä¸€æ¬¡æƒ…å ±ãƒ»å…¬çš„æƒ…å ±ï¼‰ã«ã‚‚è§¦ã‚Œã‚‹ã€‚</li>
        </ul>
      </div>
      <div class="kpi">
        <span class="tag">ç›®æ¨™ï¼šè¨€èªåŒ–</span>
        <span class="tag">åˆ¶é™ï¼š5æš</span>
        <span class="tag">è¦³ç‚¹ï¼šç”¨é€”ï¼‹ç†ç”±</span>
      </div>
      <div class="actions no-print">
        <button class="primary" id="goto1">STEP1ã¸</button>
        <button class="primary" id="goto2">STEP2ã¸</button>
        <button class="primary" id="goto3">STEP3ã¸</button>
        <button class="primary" id="goto4">æŒ¯ã‚Šè¿”ã‚Šã¸</button>
        <button class="primary" id="goto5">æå‡ºã¸</button>
      </div>
    </section>

    <section class="card" id="step1">
      <h2>STEP1ï¼šé˜²ç½ã§æ€ã„ã¤ãã‚°ãƒƒã‚ºã‚’æ›¸ãå‡ºã™ï¼ˆç”¨é€”ã¤ãï¼‰</h2>
      <div class="hint">
        <div class="split">
          <div>
            <b>ãƒ«ãƒ¼ãƒ«</b>
            <ul>
              <li>æœ€ä½ <b>6å€‹</b>ï¼ˆã§ãã‚Œã°10å€‹ï¼‰</li>
              <li>ã€Œãã‚ŒãŒãªã„ã¨ä½•ãŒå›°ã‚‹ï¼Ÿã€ã¾ã§æ›¸ã</li>
              <li>å®¶ã«ã‚ã‚‹ï¼ãªã„ã€ã§ã‚‚OK</li>
            </ul>
          </div>
          <div>
            <b>ãƒ’ãƒ³ãƒˆï¼ˆè¦–ç‚¹ï¼‰</b>
            <ul>
              <li>é£Ÿã¹ã‚‹ãƒ»é£²ã‚€</li>
              <li>ãƒˆã‚¤ãƒ¬</li>
              <li>ä½“æ¸©ãƒ»é›¨é¢¨</li>
              <li>æ˜ã‹ã‚Šãƒ»æƒ…å ±</li>
              <li>ã‚±ã‚¬ãƒ»é€£çµ¡å…ˆ</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="actions no-print">
        <button id="addRow">ï¼‹è¡Œã‚’è¿½åŠ </button>
        <button id="save1" class="ok">ä¿å­˜</button>
        <button id="toStep2" class="primary">æ¬¡ã¸ï¼ˆSTEP2ï¼‰</button>
      </div>

      <table id="brainTable">
        <thead>
          <tr>
            <th style="width:32%">ã‚°ãƒƒã‚ºå</th>
            <th>ç”¨é€”ï¼ˆä½•ã«ä½¿ã†ï¼Ÿï¼‰</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="tiny">â€»å…¥åŠ›ã—ãŸå†…å®¹ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆæ•°ç§’ãŠãï¼‰</div>
    </section>

    <section class="card hidden" id="step2">
      <h2>STEP2ï¼šå®¶æ—æ§‹æˆã‚’é¸æŠ â†’ ã‚«ãƒ¼ãƒ‰5æšã‚’é¸ã¶</h2>
      
      <div class="hint">
        ã¾ãšã€ã‚ãªãŸï¼ˆã¾ãŸã¯ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã®å®¶æ—è¨­å®šã‚’é¸ã‚“ã§ãã ã•ã„ã€‚å®¶æ—æ§‹æˆã‚„ç’°å¢ƒã®äº‹ã‚’è€ƒãˆãªãŒã‚‰å‚™è“„ã™ã‚‹ç‰©ã‚’é¸ã³ã¾ã—ã‚‡ã†ã€‚
      </div>

      <div style="margin-top:16px">
        <label class="tiny" style="font-weight:700">å®¶æ—æ§‹æˆã‚’é¸æŠ</label>
        <select id="familySelect" style="margin-top:6px">
          <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
          <option value="family1">2äººå®¶æ—ï¼ˆè¦ªãƒ»å°å­¦ç”Ÿã®å­ã©ã‚‚ï¼‰- éƒ½ä¼šåœ¨ä½ã€è¿‘æ‰€ä»˜ãåˆã„å°‘ãªã„ã€è¿‘æ‰€ã«å•†åº—å¤šã„</option>
          <option value="family2">3äººå®¶æ—ï¼ˆçˆ¶ãƒ»æ¯ãƒ»ä¸­å­¦ç”Ÿã®æ¯å­ï¼‰- å°éº¦ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æŒã¡ã€è²¯è“„ã‚¹ãƒšãƒ¼ã‚¹å°‘ãªã„</option>
          <option value="family3">4äººå®¶æ—ï¼ˆçˆ¶ãƒ»æ¯ãƒ»å°å­¦ç”Ÿã®å­ã©ã‚‚ãƒ»ä¹³å…ï¼‰- éƒ½ä¼šã®ã‚¿ãƒ¯ãƒ¼ãƒãƒ³ã‚·ãƒ§ãƒ³åœ¨ä½</option>
          <option value="family4">5äººå®¶æ—ï¼ˆç¥–çˆ¶æ¯ãƒ»çˆ¶ãƒ»æ¯ãƒ»é«˜æ ¡ç”Ÿãƒ»ä¸­å­¦ç”Ÿï¼‰- ç”°èˆåœ¨ä½ã€ãƒ©ã‚¤ãƒ•ãƒ©ã‚¤ãƒ³æ­¢ã¾ã‚Šã‚„ã™ã„ã€æ¶ˆé˜²å›£æ‰€å±</option>
          <option value="family5">5äººå®¶æ—ï¼ˆç¥–çˆ¶ãƒ»ç¥–æ¯ãƒ»çˆ¶ãƒ»æ¯ãƒ»å¹¼å…ï¼‰- ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¹ãƒˆãƒƒã‚¯å®Ÿæ–½ã€æ¯ã¯å¦Šå¨ ä¸­</option>
          <option value="custom">ãã®ä»–ï¼ˆè‡ªç”±ã«è¨­å®šï¼‰</option>
        </select>
      </div>

      <div id="customFamilyWrap" class="hidden" style="margin-top:12px">
        <label class="tiny" style="font-weight:700">å®¶æ—æ§‹æˆã®è©³ç´°</label>
        <textarea id="customFamily" placeholder="ä¾‹ï¼š3äººå®¶æ—ï¼ˆçˆ¶ãƒ»æ¯ãƒ»é«˜æ ¡ç”Ÿã®å¨˜ï¼‰ã€ãƒšãƒƒãƒˆã‚ã‚Šã€ãƒãƒ³ã‚·ãƒ§ãƒ³ä½ã¾ã„"></textarea>
      </div>

      <div id="selectedFamilyDisplay" class="hidden" style="margin-top:12px; padding:12px; background:var(--dg-color-surface); border-radius:var(--dg-radius-sm); border:1px solid var(--dg-color-border)">
        <div class="tiny" style="font-weight:700;margin-bottom:6px">é¸æŠã—ãŸå®¶æ—è¨­å®š</div>
        <div id="selectedFamilyText" style="font-size:14px"></div>
      </div>

      <hr style="border:none;border-top:1px solid var(--dg-color-border);margin:20px 0"/>

      <h3 style="margin:0 0 8px;font-size:16px;font-weight:700">é…å¸ƒã‚«ãƒ¼ãƒ‰ã‹ã‚‰5æšé¸ã¶</h3>
      <div class="hint">
        é…å¸ƒã‚«ãƒ¼ãƒ‰ã®ä¾‹ï¼šãƒ©ã‚¸ã‚ªã¯ã€Œã‚¹ãƒãƒ›ãŒä½¿ãˆãªãã¦ã‚‚ç·Šæ€¥åœ°éœ‡é€Ÿå ±ãªã©ã®æƒ…å ±ã‚’å—ä¿¡ã§ãã‚‹ã€ç­‰ãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚<span class="tiny">ï¼ˆé…å¸ƒPDFã®å†…å®¹ã«åŸºã¥ãï¼‰</span>
      </div>

      <div class="actions no-print">
        <span class="pill">é¸æŠï¼š<span class="count" id="pickedCount">0</span>/5</span>
        <button id="clearPick">é¸æŠè§£é™¤</button>
        <button id="toStep3" class="primary">æ¬¡ã¸ï¼ˆSTEP3ï¼‰</button>
      </div>

      <div class="cards" id="cards"></div>

      <hr style="border:none;border-top:1px solid var(--dg-color-border);margin:14px 0"/>

      <h3 style="margin:0 0 10px">é¸ã‚“ã 5æšï¼šç†ç”±ã‚’æ›¸ã</h3>
      <div class="two" id="reasons"></div>
      <div class="actions no-print">
        <button id="save2" class="ok">ä¿å­˜</button>
      </div>
    </section>

    <section class="card hidden" id="step3">
      <h2>STEP3ï¼ˆä»»æ„ï¼‰ï¼šã‚«ãƒ¼ãƒ‰ã‚’è‡ªä½œã™ã‚‹</h2>
      <div class="hint">
        ã€Œè‡ªåˆ†ãªã‚‰ã“ã‚Œã‚’å…¥ã‚Œã‚‹ã€ã‚’ã‚«ãƒ¼ãƒ‰åŒ–ã€‚ç”»åƒã¯ãªãã¦ã‚‚OKï¼ˆçµµæ–‡å­—ã§ã‚‚OKï¼‰ã€‚<br/>
        ä½œæˆã—ãŸã‚«ãƒ¼ãƒ‰ã¯ã€STEP2ã®ä¸€è¦§ã«ã‚‚è¿½åŠ ã§ãã¾ã™ã€‚
      </div>
      <div class="actions no-print">
        <button class="primary" id="openModal">ï¼‹ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ</button>
        <button class="primary" id="toStep4">æ¬¡ã¸ï¼ˆæŒ¯ã‚Šè¿”ã‚Šï¼‰</button>
      </div>
      <div class="cards" id="customCards"></div>
    </section>

    <section class="card hidden" id="step4">
      <h2>æŒ¯ã‚Šè¿”ã‚Šã‚·ãƒ¼ãƒˆ</h2>
      <div class="hint">
        é˜²ç½å‚™è“„å“ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã‚’é€šã—ã¦è€ƒãˆãŸã“ã¨ã€å­¦ã‚“ã ã“ã¨ã‚’è¨˜å…¥ã—ã¾ã—ã‚‡ã†ã€‚
      </div>

      <div style="margin-top:16px">
        <label class="tiny" style="font-weight:700">â‘ ã‚ãªãŸã®ã‚°ãƒ«ãƒ¼ãƒ—ã®è¨­å®šå†…å®¹</label>
        <textarea id="worksheet1" placeholder="å®¶æ—æ§‹æˆã‚„ç‰¹å¾´ãªã©" style="margin-top:6px;min-height:70px"></textarea>
      </div>

      <div style="margin-top:16px">
        <label class="tiny" style="font-weight:700">â‘¡ã‚ãªãŸã®ã‚°ãƒ«ãƒ¼ãƒ—ãŒé¸ã‚“ã é˜²ç½å‚™å“ã¨ãã®ç†ç”±</label>
        <textarea id="worksheet2" placeholder="STEP2ã§é¸ã‚“ã ã‚‚ã®ã¨ãã®ç†ç”±ã‚’ã¾ã¨ã‚ã¦æ›¸ã„ã¦ãã ã•ã„" style="margin-top:6px;min-height:100px"></textarea>
      </div>

      <div style="margin-top:16px">
        <label class="tiny" style="font-weight:700">â‘¢ä»–ã®ã‚°ãƒ«ãƒ¼ãƒ—ãŒé¸ã‚“ã å‚™å“ã¨ãã®ç†ç”±ã§ã‚ˆã‹ã£ãŸç‰©</label>
        <textarea id="worksheet3" placeholder="ä»–ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ç™ºè¡¨ã‚’èã„ã¦ã€å‚è€ƒã«ãªã£ãŸã‚‚ã®ã‚’æ›¸ã„ã¦ãã ã•ã„" style="margin-top:6px;min-height:90px"></textarea>
      </div>

      <div style="margin-top:16px">
        <label class="tiny" style="font-weight:700">â‘£é¸ã‚“ã ã‚‚ã®ä»¥å¤–ã«ã€Œã“ã‚“ãªã‚‚ã®ãŒã‚ã‚Œã°ä¾¿åˆ©ã ã€ã¨è€ƒãˆãŸã‚‚ã®</label>
        <textarea id="worksheet4" placeholder="æç¤ºã•ã‚ŒãŸé˜²ç½ã‚°ãƒƒã‚ºä»¥å¤–ã§è€ƒãˆã‚ˆã†" style="margin-top:6px;min-height:90px"></textarea>
      </div>

      <div style="margin-top:16px">
        <label class="tiny" style="font-weight:700">â‘¤ä»Šå›ã®ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ ã‚’å—ã‘ã¦æ€ã£ãŸã“ã¨</label>
        <textarea id="worksheet5" placeholder="æ„Ÿæƒ³ã‚„æ°—ã¥ãã€ä»Šå¾Œã«æ´»ã‹ã—ãŸã„ã“ã¨ãªã©" style="margin-top:6px;min-height:100px"></textarea>
      </div>

      <div class="actions no-print">
        <button id="save4" class="ok">ä¿å­˜</button>
        <button class="primary" id="toStep5">æ¬¡ã¸ï¼ˆæå‡ºï¼‰</button>
      </div>
    </section>

    <section class="card hidden" id="step5">
      <h2>æå‡ºç”¨ï¼ˆã‚³ãƒ”ãƒšç”¨ï¼‰</h2>
      <div class="hint">ä¸‹ã®ãƒœã‚¿ãƒ³ã§ã€ã¾ã¨ã‚ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚Googleãƒ•ã‚©ãƒ¼ãƒ ã‚„Classroomæå‡ºã«è²¼ã‚Œã¾ã™ã€‚</div>
      <div class="actions no-print">
        <button class="ok" id="btnExportText">ã¾ã¨ã‚ã‚’ç”Ÿæˆ</button>
        <button id="btnCopy" disabled>ã‚³ãƒ”ãƒ¼</button>
        <button id="btnDownloadJson">JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </div>
      <textarea id="exportArea" placeholder="ã“ã“ã«å‡ºåŠ›ã•ã‚Œã¾ã™ï¼ˆç·¨é›†OKï¼‰"></textarea>
      <div class="tiny">â€»ã“ã®ãƒšãƒ¼ã‚¸ã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚å‹•ãã¾ã™ï¼ˆç”»åƒã¯åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã® bousai_cards/ ã‚’å‚ç…§ï¼‰ã€‚</div>
    </section>
  </div>
</main>

<div class="modal-back" id="modalBack" role="dialog" aria-modal="true" aria-label="ã‚«ãƒ¼ãƒ‰ä½œæˆ">
  <div class="modal">
    <div class="row" style="justify-content:space-between">
      <h3>ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ</h3>
      <button id="closeModal">é–‰ã˜ã‚‹</button>
    </div>
    <div class="two">
      <div>
        <label class="tiny">ã‚«ãƒ¼ãƒ‰å</label>
        <input id="newTitle" placeholder="ä¾‹ï¼šãƒ¢ãƒã‚¤ãƒ«ãƒãƒƒãƒ†ãƒªãƒ¼"/>
        <div style="height:10px"></div>
        <label class="tiny">èª¬æ˜ï¼ˆç”¨é€”ãƒ»ãƒã‚¤ãƒ³ãƒˆï¼‰</label>
        <textarea id="newDesc" placeholder="ä¾‹ï¼šåœé›»æ™‚ã«ã‚¹ãƒãƒ›ã‚’å……é›»ã—ã¦é€£çµ¡ã‚„æƒ…å ±åé›†ã‚’ç¶™ç¶šã§ãã‚‹"></textarea>
      </div>
      <div>
        <label class="tiny">ç”»åƒï¼ˆä»»æ„ï¼‰</label>
        <input type="file" id="newImg" accept="image/*"/>
        <div class="hint tiny" style="margin-top:8px">ç”»åƒã‚’å…¥ã‚Œã‚‹ã¨ã‚«ãƒ¼ãƒ‰ã®ä¸Šéƒ¨ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆã“ã®PCå†…ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰ã€‚</div>
        <div style="height:10px"></div>
        <label class="tiny">ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼‰</label>
        <select id="newCat">
          <option value="">æœªè¨­å®š</option>
          <option>é£Ÿæ–™ãƒ»æ°´</option>
          <option>è¡›ç”Ÿãƒ»ãƒˆã‚¤ãƒ¬</option>
          <option>é˜²å¯’ãƒ»é›¨é¢¨</option>
          <option>æ˜ã‹ã‚Š</option>
          <option>æƒ…å ±ãƒ»é€£çµ¡</option>
          <option>å¿œæ€¥æ‰‹å½“</option>
          <option>ãã®ä»–</option>
        </select>
      </div>
    </div>
    <div class="actions">
      <button class="ok" id="createCard">ä½œæˆ</button>
    </div>
  </div>
</div>

<script>
  const BASE_CARDS = [
  {
    "id": "c01",
    "name": "ã‚¢ãƒ«ãƒŸãƒ–ãƒ©ãƒ³ã‚±ãƒƒãƒˆ",
    "img": "bousai_cards/card_01.png"
  },
  {
    "id": "c02",
    "name": "æ¯›å¸ƒ",
    "img": "bousai_cards/card_02.png"
  },
  {
    "id": "c03",
    "name": "ç°¡æ˜“ãƒˆã‚¤ãƒ¬",
    "img": "bousai_cards/card_03.png"
  },
  {
    "id": "c04",
    "name": "ãƒ¬ã‚¤ãƒ³ã‚³ãƒ¼ãƒˆ",
    "img": "bousai_cards/card_04.png"
  },
  {
    "id": "c05",
    "name": "è»æ‰‹",
    "img": "bousai_cards/card_05.png"
  },
  {
    "id": "c06",
    "name": "ãƒ©ã‚¸ã‚ª",
    "img": "bousai_cards/card_06.png"
  },
  {
    "id": "c07",
    "name": "ç¬›ï¼ˆã‚µã‚¤ã‚³ãƒ¼ãƒ«ï¼‰",
    "img": "bousai_cards/card_07.png"
  },
  {
    "id": "c08",
    "name": "æ‡ä¸­é›»ç¯",
    "img": "bousai_cards/card_08.png"
  },
  {
    "id": "c09",
    "name": "ã‚¢ãƒ«ãƒŸè£½ãƒ›ã‚¤ãƒƒã‚¹ãƒ«",
    "img": "bousai_cards/card_09.png"
  },
  {
    "id": "c10",
    "name": "éå¸¸é£Ÿï¼ˆç±³Aï¼‰",
    "img": "bousai_cards/card_10.png"
  },
  {
    "id": "c11",
    "name": "éå¸¸é£Ÿï¼ˆç±³Bï¼‰",
    "img": "bousai_cards/card_11.png"
  },
  {
    "id": "c12",
    "name": "éå¸¸é£Ÿï¼ˆãƒ‘ãƒ³ï¼‰",
    "img": "bousai_cards/card_12.png"
  },
  {
    "id": "c13",
    "name": "æ°´",
    "img": "bousai_cards/card_13.png"
  }
];

  const LS_KEY = "homeroom_bousai_v1";
  const state = loadState();

  function loadState(){
    try {
      return Object.assign({
        brainstorm: [],
        picked: [],
        reasons: {},
        custom: [],
        family: "",
        customFamily: "",
        worksheet1: "",
        worksheet2: "",
        worksheet3: "",
        worksheet4: "",
        worksheet5: ""
      }, JSON.parse(localStorage.getItem(LS_KEY) || "{}"));
    } catch(e) {
      return { brainstorm:[], picked:[], reasons:{}, custom:[], family:"", customFamily:"", worksheet1:"", worksheet2:"", worksheet3:"", worksheet4:"", worksheet5:"" };
    }
  }
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  const tbody = document.querySelector("#brainTable tbody");
  const step1 = document.querySelector("#step1");
  const step2 = document.querySelector("#step2");
  const step3 = document.querySelector("#step3");
  const step4 = document.querySelector("#step4");
  const step5 = document.querySelector("#step5");
  const dot1 = document.querySelector("#dot1");
  const dot2 = document.querySelector("#dot2");
  const dot3 = document.querySelector("#dot3");
  const dot4 = document.querySelector("#dot4");
  const dot5 = document.querySelector("#dot5");

  const pickedCountEl = document.querySelector("#pickedCount");
  const cardsEl = document.querySelector("#cards");
  const reasonsEl = document.querySelector("#reasons");
  const customCardsEl = document.querySelector("#customCards");

  const familySelect = document.querySelector("#familySelect");
  const customFamilyWrap = document.querySelector("#customFamilyWrap");
  const customFamilyInput = document.querySelector("#customFamily");
  const selectedFamilyDisplay = document.querySelector("#selectedFamilyDisplay");
  const selectedFamilyText = document.querySelector("#selectedFamilyText");

  function showStep(n){
    step1.classList.toggle("hidden", n!==1);
    step2.classList.toggle("hidden", n!==2);
    step3.classList.toggle("hidden", n!==3);
    step4.classList.toggle("hidden", n!==4);
    step5.classList.toggle("hidden", n!==5);
    dot1.classList.toggle("on", n===1);
    dot2.classList.toggle("on", n===2);
    dot3.classList.toggle("on", n===3);
    dot4.classList.toggle("on", n===4);
    dot5.classList.toggle("on", n===5);
    window.scrollTo({top:0, behavior:"smooth"});
  }
  document.querySelector("#goto1").onclick = ()=>showStep(1);
  document.querySelector("#goto2").onclick = ()=>showStep(2);
  document.querySelector("#goto3").onclick = ()=>showStep(3);
  document.querySelector("#goto4").onclick = ()=>showStep(4);
  document.querySelector("#goto5").onclick = ()=>showStep(5);
  document.querySelector("#toStep2").onclick = ()=>{ saveBrainstormFromUI(); showStep(2); };
  document.querySelector("#toStep3").onclick = ()=>{ savePickedFromUI(); showStep(3); };
  document.querySelector("#toStep4").onclick = ()=>{ showStep(4); };
  document.querySelector("#toStep5").onclick = ()=>{ showStep(5); };

  function rowTemplate(item={name:"", use:""}){
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td><input class="b-name" placeholder="ä¾‹ï¼šæ‡ä¸­é›»ç¯" value="${escapeHtml(item.name||"")}"></td>
      <td><input class="b-use" placeholder="ä¾‹ï¼šåœé›»æ™‚ã®ç§»å‹•ãƒ»ä½œæ¥­ã«å¿…è¦" value="${escapeHtml(item.use||"")}"></td>
    `;
    return tr;
  }
  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }
  function renderBrainstorm(){
    tbody.innerHTML="";
    const arr = (state.brainstorm && state.brainstorm.length) ? state.brainstorm : Array.from({length:6}, ()=>({name:"",use:""}));
    arr.forEach(it => tbody.appendChild(rowTemplate(it)));
  }
  function addRow(){ tbody.appendChild(rowTemplate()); }
  function saveBrainstormFromUI(){
    const rows=[...tbody.querySelectorAll("tr")];
    state.brainstorm = rows.map(r=>({
      name: r.querySelector(".b-name").value.trim(),
      use: r.querySelector(".b-use").value.trim()
    })).filter(x=>x.name || x.use);
    saveState();
  }
  document.querySelector("#addRow").onclick = ()=>{ addRow(); };
  document.querySelector("#save1").onclick = ()=>{ saveBrainstormFromUI(); toast("ä¿å­˜ã—ã¾ã—ãŸ"); };

  let t=null;
  tbody.addEventListener("input", ()=>{
    clearTimeout(t);
    t=setTimeout(()=>{ saveBrainstormFromUI(); }, 800);
  });

  function allCards(){
    return [...BASE_CARDS, ...state.custom.map(c=>({
      id:c.id, name:c.title, img:c.imgDataUrl || "", desc:c.desc || "", cat:c.cat || "è‡ªä½œ"
    }))];
  }

  function getCardDescByName(name){
    const map = {
      "ã‚¢ãƒ«ãƒŸãƒ–ãƒ©ãƒ³ã‚±ãƒƒãƒˆ":"è»½ãã¦é˜²å¯’ã€‚éå¸¸æ™‚ã®ä½“æ¸©ä¿æŒã«å½¹ç«‹ã¤ã€‚",
      "æ¯›å¸ƒ":"é˜²å¯’ãƒ»ç°¡æ˜“å¯å…·ã€‚ä½“æ¸©ä½ä¸‹ã‚’é˜²ãã€‚",
      "ç°¡æ˜“ãƒˆã‚¤ãƒ¬":"è¡›ç”Ÿã¨ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›ã€‚æ–­æ°´æ™‚ã«é‡è¦ã€‚",
      "ãƒ¬ã‚¤ãƒ³ã‚³ãƒ¼ãƒˆ":"é›¨ãƒ»é¢¨ã‚’é˜²ãã€ä½“æ¸©ä½ä¸‹ã‚„æ¿¡ã‚Œã‚’é˜²ãã€‚",
      "è»æ‰‹":"æ‰‹ã®ä¿è­·ã€‚ç‰‡ä»˜ã‘ã‚„æ•‘åŠ©ã§ã‚±ã‚¬ã‚’é˜²ãã€‚",
      "ãƒ©ã‚¸ã‚ª":"ã‚¹ãƒãƒ›ãŒä½¿ãˆãªãã¦ã‚‚ç·Šæ€¥åœ°éœ‡é€Ÿå ±ãªã©æƒ…å ±ã‚’å—ä¿¡ã§ãã‚‹ã€‚",
      "ç¬›ï¼ˆã‚µã‚¤ã‚³ãƒ¼ãƒ«ï¼‰":"å±…å ´æ‰€ã‚’çŸ¥ã‚‰ã›ã‚‹ã€‚å¼±ã„æ¯ã§ã‚‚éŸ³ãŒå‡ºã‚‹ã€‚",
      "æ‡ä¸­é›»ç¯":"æš—ã„å ´æ‰€ã§ã®ç§»å‹•ãƒ»ä½œæ¥­ã€‚å±…å ´æ‰€ã‚’çŸ¥ã‚‰ã›ã‚‹ã“ã¨ã«ã‚‚ã€‚",
      "ã‚¢ãƒ«ãƒŸè£½ãƒ›ã‚¤ãƒƒã‚¹ãƒ«":"å±…å ´æ‰€ã‚’çŸ¥ã‚‰ã›ã‚‹ã€‚IDã‚«ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã‚‰ã‚Œã‚‹ã‚¿ã‚¤ãƒ—ã‚‚ã€‚",
      "éå¸¸é£Ÿï¼ˆç±³Aï¼‰":"æ°´ã§æˆ»ã™ã‚¿ã‚¤ãƒ—ã®ã”ã¯ã‚“ã€‚ä¿å­˜ãŒããã€‚",
      "éå¸¸é£Ÿï¼ˆç±³Bï¼‰":"ãƒ¬ãƒˆãƒ«ãƒˆã‚¿ã‚¤ãƒ—ã®ã”ã¯ã‚“ã€‚é–‹ã‘ã¦ã™ãé£Ÿã¹ã‚‰ã‚Œã‚‹ã€‚",
      "éå¸¸é£Ÿï¼ˆãƒ‘ãƒ³ï¼‰":"ãƒ¬ãƒˆãƒ«ãƒˆãƒ‘ãƒ³ç­‰ã€‚ä¿å­˜ãŒããã€‚",
      "æ°´":"é£²æ–™æ°´ã€‚ç›®å®‰ã¯1äºº1æ—¥1ã€œ2Lã€‚"
    };
    return map[name] || "";
  }

  function renderCards(){
    const list = allCards();
    cardsEl.innerHTML="";
    list.forEach(c=>{
      const div=document.createElement("div");
      div.className="item" + (state.picked.includes(c.id) ? " selected" : "");
      const desc = c.desc || getCardDescByName(c.name);
      div.innerHTML = `
        <div class="thumb">${c.img ? `<img alt="" src="${c.img}">` : `<div class="tiny">ï¼ˆç”»åƒãªã—ï¼‰</div>`}</div>
        <div class="body">
          <div class="title">${escapeHtml(c.name)}</div>
          <div class="desc">${escapeHtml(desc)}</div>
          <div class="tiny" style="margin-top:8px">ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ/è§£é™¤</div>
        </div>
      `;
      div.onclick = ()=>togglePick(c.id);
      cardsEl.appendChild(div);
    });
    updatePickedUI();
    renderReasons();
  }

  function togglePick(id){
    const idx = state.picked.indexOf(id);
    if(idx>=0){
      state.picked.splice(idx,1);
      delete state.reasons[id];
      saveState();
      renderCards();
      return;
    }
    if(state.picked.length>=5){
      toast("5æšã¾ã§ã§ã™");
      return;
    }
    state.picked.push(id);
    saveState();
    renderCards();
  }

  function updatePickedUI(){ pickedCountEl.textContent = String(state.picked.length); }

  function renderReasons(){
    reasonsEl.innerHTML="";
    const list = allCards();
    const byId = Object.fromEntries(list.map(c=>[c.id,c]));
    state.picked.forEach(id=>{
      const c=byId[id];
      const wrap=document.createElement("div");
      wrap.className="card";
      wrap.style.background="var(--dg-color-surface)";
      wrap.style.boxShadow="var(--dg-shadow-sm)";
      wrap.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div style="font-weight:900">${escapeHtml(c?.name || id)}</div>
            <div class="tiny">${escapeHtml((c?.desc || getCardDescByName(c?.name||"")) || "")}</div>
          </div>
          <span class="tag">é¸æŠ</span>
        </div>
        <div class="reason">
          <label class="tiny">ç†ç”±ï¼ˆãªãœå¿…è¦ï¼Ÿã©ã‚“ãªå ´é¢ï¼Ÿï¼‰</label>
          <textarea data-reason="${id}" placeholder="ä¾‹ï¼šåœé›»ã§ã‚¹ãƒãƒ›ãŒä½¿ãˆãªã„ã¨ãã€æƒ…å ±ãŒå–ã‚Œãšä¸å®‰ã€‚ãƒ©ã‚¸ã‚ªãªã‚‰â€¦">${escapeHtml(state.reasons[id]||"")}</textarea>
        </div>
      `;
      reasonsEl.appendChild(wrap);
    });

    reasonsEl.querySelectorAll("textarea[data-reason]").forEach(t=>{
      t.addEventListener("input", ()=>{
        state.reasons[t.dataset.reason]=t.value;
        saveState();
      });
    });
  }

  function savePickedFromUI(){ saveState(); }

  document.querySelector("#clearPick").onclick = ()=>{
    if(!confirm("é¸æŠã‚’ã™ã¹ã¦è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    state.picked=[];
    state.reasons={};
    saveState();
    renderCards();
  };
  document.querySelector("#save2").onclick = ()=>{ savePickedFromUI(); toast("ä¿å­˜ã—ã¾ã—ãŸ"); };

  // Family selection
  familySelect.value = state.family || "";
  customFamilyInput.value = state.customFamily || "";
  
  familySelect.addEventListener("change", ()=>{
    state.family = familySelect.value;
    if(familySelect.value === "custom"){
      customFamilyWrap.classList.remove("hidden");
      selectedFamilyDisplay.classList.add("hidden");
    } else if(familySelect.value){
      customFamilyWrap.classList.add("hidden");
      selectedFamilyDisplay.classList.remove("hidden");
      selectedFamilyText.textContent = familySelect.options[familySelect.selectedIndex].text;
    } else {
      customFamilyWrap.classList.add("hidden");
      selectedFamilyDisplay.classList.add("hidden");
    }
    saveState();
  });

  customFamilyInput.addEventListener("input", ()=>{
    state.customFamily = customFamilyInput.value;
    saveState();
  });

  // Initialize family display
  if(state.family === "custom" && state.customFamily){
    customFamilyWrap.classList.remove("hidden");
  } else if(state.family){
    selectedFamilyDisplay.classList.remove("hidden");
    const opt = Array.from(familySelect.options).find(o=>o.value===state.family);
    if(opt) selectedFamilyText.textContent = opt.text;
  }

  // STEP3
  function renderCustomCards(){
    customCardsEl.innerHTML="";
    if(state.custom.length===0){
      const d=document.createElement("div");
      d.className="hint";
      d.textContent="ã¾ã è‡ªä½œã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
      customCardsEl.appendChild(d);
      return;
    }
    state.custom.forEach(c=>{
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`
        <div class="thumb">${c.imgDataUrl ? `<img alt="" src="${c.imgDataUrl}">` : `<div class="tiny">ï¼ˆç”»åƒãªã—ï¼‰</div>`}</div>
        <div class="body">
          <div class="title">${escapeHtml(c.title)}</div>
          <div class="desc">${escapeHtml(c.desc||"")}</div>
          <div class="row no-print" style="justify-content:space-between; margin-top:10px">
            <span class="tag">${escapeHtml(c.cat||"è‡ªä½œ")}</span>
            <button class="danger" data-del="${c.id}">å‰Šé™¤</button>
          </div>
        </div>
      `;
      customCardsEl.appendChild(div);
    });
    customCardsEl.querySelectorAll("button[data-del]").forEach(b=>{
      b.onclick = ()=>{
        const id=b.dataset.del;
        if(!confirm("ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        state.custom = state.custom.filter(x=>x.id!==id);
        state.picked = state.picked.filter(x=>x!==id);
        delete state.reasons[id];
        saveState();
        renderCustomCards();
        renderCards();
      };
    });
  }

  const modalBack = document.querySelector("#modalBack");
  document.querySelector("#openModal").onclick = ()=> modalBack.classList.add("show");
  document.querySelector("#closeModal").onclick = ()=> modalBack.classList.remove("show");
  modalBack.addEventListener("click", (e)=>{ if(e.target===modalBack) modalBack.classList.remove("show"); });

  function readFileAsDataURL(file){
    return new Promise((res,rej)=>{
      const r=new FileReader();
      r.onload=()=>res(r.result);
      r.onerror=()=>rej(r.error);
      r.readAsDataURL(file);
    });
  }

  document.querySelector("#createCard").onclick = async ()=>{
    const title = document.querySelector("#newTitle").value.trim();
    const desc = document.querySelector("#newDesc").value.trim();
    const cat = document.querySelector("#newCat").value;
    const file = document.querySelector("#newImg").files?.[0];
    if(!title){ toast("ã‚«ãƒ¼ãƒ‰åã¯å¿…é ˆã§ã™"); return; }
    let imgDataUrl="";
    if(file){ imgDataUrl = await readFileAsDataURL(file); }
    const id = "u" + Date.now().toString(36);
    state.custom.unshift({id, title, desc, imgDataUrl, cat});
    saveState();
    document.querySelector("#newTitle").value="";
    document.querySelector("#newDesc").value="";
    document.querySelector("#newImg").value="";
    document.querySelector("#newCat").value="";
    modalBack.classList.remove("show");
    renderCustomCards();
    renderCards();
    toast("ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆSTEP2ã«ã‚‚åæ˜ ï¼‰");
  };

  // STEP4 - Worksheet
  const worksheet1 = document.querySelector("#worksheet1");
  const worksheet2 = document.querySelector("#worksheet2");
  const worksheet3 = document.querySelector("#worksheet3");
  const worksheet4 = document.querySelector("#worksheet4");
  const worksheet5 = document.querySelector("#worksheet5");

  worksheet1.value = state.worksheet1 || "";
  worksheet2.value = state.worksheet2 || "";
  worksheet3.value = state.worksheet3 || "";
  worksheet4.value = state.worksheet4 || "";
  worksheet5.value = state.worksheet5 || "";

  [worksheet1, worksheet2, worksheet3, worksheet4, worksheet5].forEach((el, idx)=>{
    el.addEventListener("input", ()=>{
      state[`worksheet${idx+1}`] = el.value;
      saveState();
    });
  });

  document.querySelector("#save4").onclick = ()=>{ saveState(); toast("ä¿å­˜ã—ã¾ã—ãŸ"); };

  // export
  const exportArea = document.querySelector("#exportArea");
  const btnCopy = document.querySelector("#btnCopy");

  function buildExportText(){
    const list = allCards();
    const byId = Object.fromEntries(list.map(c=>[c.id,c]));
    const lines=[];
    
    lines.push("ã€é˜²ç½å‚™è“„å“ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ  æŒ¯ã‚Šè¿”ã‚Šã‚·ãƒ¼ãƒˆã€‘");
    lines.push("");
    
    lines.push("ã€STEP1 é˜²ç½ã‚°ãƒƒã‚ºæ¡ˆã€‘");
    if(state.brainstorm.length===0){
      lines.push("ï¼ˆæœªå…¥åŠ›ï¼‰");
    } else {
      state.brainstorm.forEach((x,i)=>{
        lines.push(`${i+1}. ${x.name||"ï¼ˆåç§°ãªã—ï¼‰"}ï¼š${x.use||"ï¼ˆç”¨é€”ãªã—ï¼‰"}`);
      });
    }
    lines.push("");
    
    lines.push("ã€STEP2 å®¶æ—æ§‹æˆè¨­å®šã€‘");
    if(state.family){
      if(state.family === "custom"){
        lines.push(state.customFamily || "ï¼ˆæœªå…¥åŠ›ï¼‰");
      } else {
        const opt = Array.from(familySelect.options).find(o=>o.value===state.family);
        lines.push(opt ? opt.text : state.family);
      }
    } else {
      lines.push("ï¼ˆæœªé¸æŠï¼‰");
    }
    lines.push("");
    
    lines.push("ã€STEP2 é…å¸ƒã‚«ãƒ¼ãƒ‰ 5æšã€‘");
    if(state.picked.length===0){
      lines.push("ï¼ˆæœªé¸æŠï¼‰");
    } else {
      state.picked.forEach((id,i)=>{
        const c=byId[id];
        const name=c?.name||id;
        const reason=(state.reasons[id]||"").trim() || "ï¼ˆç†ç”±æœªå…¥åŠ›ï¼‰";
        lines.push(`${i+1}. ${name}`);
        lines.push(`   ç†ç”±ï¼š${reason.replaceAll("\n"," / ")}`);
      });
    }
    lines.push("");
    
    lines.push("ã€STEP3 è‡ªä½œã‚«ãƒ¼ãƒ‰ã€‘");
    if(state.custom.length===0){
      lines.push("ï¼ˆãªã—ï¼‰");
    } else {
      state.custom.forEach((c,i)=>{
        lines.push(`${i+1}. ${c.title}ï¼š${(c.desc||"").replaceAll("\n"," / ")}`);
      });
    }
    lines.push("");
    
    lines.push("ã€æŒ¯ã‚Šè¿”ã‚Šã‚·ãƒ¼ãƒˆã€‘");
    lines.push("");
    lines.push("â‘ ã‚ãªãŸã®ã‚°ãƒ«ãƒ¼ãƒ—ã®è¨­å®šå†…å®¹");
    lines.push(state.worksheet1 || "ï¼ˆæœªå…¥åŠ›ï¼‰");
    lines.push("");
    lines.push("â‘¡ã‚ãªãŸã®ã‚°ãƒ«ãƒ¼ãƒ—ãŒé¸ã‚“ã é˜²ç½å‚™å“ã¨ãã®ç†ç”±");
    lines.push(state.worksheet2 || "ï¼ˆæœªå…¥åŠ›ï¼‰");
    lines.push("");
    lines.push("â‘¢ä»–ã®ã‚°ãƒ«ãƒ¼ãƒ—ãŒé¸ã‚“ã å‚™å“ã¨ãã®ç†ç”±ã§ã‚ˆã‹ã£ãŸç‰©");
    lines.push(state.worksheet3 || "ï¼ˆæœªå…¥åŠ›ï¼‰");
    lines.push("");
    lines.push("â‘£é¸ã‚“ã ã‚‚ã®ä»¥å¤–ã«ã€Œã“ã‚“ãªã‚‚ã®ãŒã‚ã‚Œã°ä¾¿åˆ©ã ã€ã¨è€ƒãˆãŸã‚‚ã®");
    lines.push(state.worksheet4 || "ï¼ˆæœªå…¥åŠ›ï¼‰");
    lines.push("");
    lines.push("â‘¤ä»Šå›ã®ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ ã‚’å—ã‘ã¦æ€ã£ãŸã“ã¨");
    lines.push(state.worksheet5 || "ï¼ˆæœªå…¥åŠ›ï¼‰");
    
    return lines.join("\n");
  }

  document.querySelector("#btnExportText").onclick = ()=>{
    exportArea.value = buildExportText();
    btnCopy.disabled = !exportArea.value.trim();
    toast("ã¾ã¨ã‚ã‚’ç”Ÿæˆã—ã¾ã—ãŸ");
  };
  btnCopy.onclick = async ()=>{
    await navigator.clipboard.writeText(exportArea.value);
    toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  };

  document.querySelector("#btnDownloadJson").onclick = ()=>{
    const blob = new Blob([JSON.stringify({...state, exportedAt: new Date().toISOString()}, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="homeroom_bousai_result.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  document.querySelector("#btnPrint").onclick = ()=>window.print();
  document.querySelector("#btnReset").onclick = ()=>{
    if(!confirm("ã“ã®ãƒšãƒ¼ã‚¸ã®ä¿å­˜å†…å®¹ã‚’ã™ã¹ã¦æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem(LS_KEY);
    location.reload();
  };

  function toast(msg){
    const d=document.createElement("div");
    d.textContent=msg;
    d.style.position="fixed";
    d.style.left="50%";
    d.style.bottom="18px";
    d.style.transform="translateX(-50%)";
    d.style.padding="10px 14px";
    d.style.border="1px solid var(--dg-color-border)";
    d.style.background="var(--dg-color-bg)";
    d.style.color="var(--dg-color-text)";
    d.style.borderRadius="999px";
    d.style.zIndex="999";
    d.style.boxShadow="0 8px 24px rgba(15, 23, 42, 0.18)";
    d.style.fontWeight="600";
    document.body.appendChild(d);
    setTimeout(()=>d.remove(), 1600);
  }

  renderBrainstorm();
  renderCards();
  renderCustomCards();
  showStep(1);
</script>
</body>
</html>
